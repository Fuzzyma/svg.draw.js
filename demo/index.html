<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Svg.draw.js : Demo-Page">

    <link rel="stylesheet" type="text/css" media="screen" href="demo.css">
    <link rel="shortcut icon" href="favicon.png" type="image/png" />

    <title>Svg.draw.js | Demo-Page</title>

  </head>

  <body>
  <div id="container">
    <h1>svg.draw.js - Demo</h1>

    <div class="box">
      <h2>Rectangle, click to draw</h2>
      <code>
        new SVG('rect').size('100%', '100%')
            .rect().draw();
      </code>
      <div id="rect"></div>
    </div>

    <div class="box">
      <h2>Transformed Rectangle, click to draw</h2>
      <code>
        new SVG('rect_transformed').size('100%', '100%')
            .rect().draw().scale(4).rotation(45);
      </code>
      <div id="rect_transformed"></div>
    </div>

    <div class="box">
      <h2>Polygon, press Enter to finish the shape</h2>
      <code>
        var poly1 = new SVG('polygon').size('100%', '100%')
            .polygon().draw();

        poly1.on('drawstart', function(e){
            document.addEventListener('keydown', function(e){
                if(e.keyCode == 13){
                    poly1.draw('done');
                    poly1.off('drawstart');
                }
            });
        });

        poly1.on('drawstop', function(){
            // remove listener
        });
      </code>
      <div id="polygon"></div>
    </div>
    <div class="box">
      <h2>Ellipse, click to draw</h2>
      <code>
        new SVG('ellipse').size('100%', '100%')
            .ellipse().draw();
      </code>
      <div id="ellipse"></div>
    </div>
    <div class="box">
      <h2>Circle, click to draw</h2>
      <code>
        new SVG('circle').size('100%', '100%')
            .circle().draw();
      </code>
      <div id="circle"></div>
    </div>
    <div class="box">
      <h2>Polygon, aligned to grid</h2>
      <code>
        var poly2 = new SVG('polygonGrid').size('100%', '100%')
            .polygon().draw({snapToGrid:20});

        poly2.on('drawstart', function(e){
            document.addEventListener('keydown', function(e){
                if(e.keyCode == 13){
                    poly2.draw('done');
                    poly2.off('drawstart');
                }
            });
        });

        poly2.on('drawstop', function(){
            // remove listener
        });
      </code>
      <div id="polygonGrid"></div>
    </div>

    <div class="box">
      <h2>Polygon, aligned to grid with ctrl pressed</h2>
      <code>
        var poly3 = new SVG('polygonGridOnCtrl').size('100%', '100%')
            .polygon().draw({snapToGrid:20});

        poly3.on('drawstart', function(e){
            document.addEventListener('keydown', function(e){
                if(e.keyCode == 13){
                    poly3.draw('done');
                    poly3.off('drawstart');
                }
                if(e.keyCode == 17){
                    poly3.draw('param', 'snapToGrid', 20);
                }
            });

            document.addEventListener('keyup', function(e){
                poly3.draw('param', 'snapToGrid', 1);
            });
        });

        poly3.on('drawstop', function(){
            // remove listener
        });
      </code>
      <div id="polygonGridOnCtrl"></div>
    </div>

    <div class="box">
      <h2>Rectangle, mousedown/move/up to draw</h2>
      <code>
        var drawing = new SVG('rectNoClick').size('100%', '100%');
        var rect = drawing.rect();

        drawing.on('mousedown', function(e){
            rect.draw(e);
        }, false);

        drawing.on('mouseup', function(e){
            rect.draw('stop', e);
        }, false);

        rect.on('drawstop', function(){
            // remove listener
        });
      </code>
      <div id="rectNoClick"></div>
    </div>

    <div class="box">
      <h2>Polyline, snap to 45 degrees</h2>
      <code>
        var drawing = new SVG('rectNoClick').size('100%', '100%');
        var rect = drawing.rect();

        drawing.on('mousedown', function(e){
            rect.draw(e);
        }, false);

        drawing.on('mouseup', function(e){
            rect.draw('stop', e);
        }, false);

        rect.on('drawstop', function(){
            // remove listener
        });
      </code>
      <div id="degree45"></div>
    </div>

  </div>

    <script src="svg.js"></script>
    <script src="../dist/svg.draw.js"></script>
    <script>
      'use strict'

      // rect()
      // rect_transformed()
      // polygon()
      // ellipse()
      // circle()
      // polygonGrid()
      // polygonGridOnCtrl()
      // rectNoClick()
      degree45()

      function rect () {
        new SVG('rect').size('100%', '100%').rect().draw().attr('stroke-width',1).attr('fill','none');
      }

      function rect_transformed () {
        new SVG('rect_transformed').size('100%', '100%').rect().draw().attr('stroke-width',1).attr('fill','none').scale(4).rotate(45);
      }

      function polygon () {
        var poly = new SVG('polygon').size('100%', '100%').polygon().draw().attr('stroke-width',1).attr('fill','none');

        poly.on('drawstart', function(e){
          document.addEventListener('keydown', function(e){
              if(e.keyCode == 13){
                poly.draw('done');
                poly.off('drawstart');
              }
          });
        });
      }

      function ellipse () {
        new SVG('ellipse').size('100%', '100%').ellipse().draw().attr('stroke-width',1).attr('fill','none');
      }

      function circle () {
        new SVG('circle').size('100%', '100%').circle().draw().attr('stroke-width',1).attr('fill','none');
      }

      function polygonGrid () {
        var poly2 = new SVG('polygonGrid').size('100%', '100%').polygon().draw({snapToGrid:20}).attr('stroke-width',1).attr('fill','none');

        poly2.on('drawstart', function(e){
          document.addEventListener('keydown', function(e){
            if(e.keyCode == 13){
              poly2.draw('done');
              poly2.off('drawstart');
            }
          });
        });
      }

      function polygonGridOnCtrl () {
        var poly = new SVG('polygonGridOnCtrl').size('100%', '100%').polygon().draw().attr('stroke-width',1).attr('fill','none');

        poly.on('drawstart', function(e){
          document.addEventListener('keydown', function(e){
            if(e.keyCode == 13){
              poly.draw('done');
              poly.off('drawstart');

            }
            if(e.keyCode == 17){
              poly.draw('param', 'snapToGrid', 20);
            }
          });

          document.addEventListener('keyup', function(e){
            poly.draw('param', 'snapToGrid', 1);
          });
        });
      }

      function rectNoClick () {
        var drawing = new SVG('rectNoClick').size('100%', '100%');
        var rect = drawing.rect().attr('stroke-width',1).attr('fill','none');

        drawing.on('mousedown', function(e){
          rect.draw(e);
        }, false);

        drawing.on('mouseup', function(e){
          rect.draw('stop', e);
        }, false);
      }

      function degree45 () {
        var ENTER = 13
        var canvas = new SVG('degree45')
        var polyline = canvas.polyline().fill('none').stroke({width:2})
        var circle
        var update = true
        var startPoint, matrix
        var realLine
        var currentPoint

        canvas.on('dblclick', function (event) {
          printXY(event)

          if (currentPoint) {
            event = new CustomEvent('MouseEvent')
            event.clientX = currentPoint.clientX
            event.clientY = currentPoint.clientY
          }

          polyline.draw('point', event)

          if (realLine) realLine.remove()

          realLine = canvas
            .line()
            .stroke({width:1, color:'rgb(255, 0, 0)'})
            .opacity(.4)
        })

        canvas.on('mousemove', function () {
          update = true
        })

        polyline.on('drawstart', function (event) {
          startPoint = event.detail.p.clone()
          matrix = event.detail.m

          circle = createCircle(canvas, startPoint)

          document.addEventListener('keydown', function (event) {
            if (event.keyCode === ENTER) {
              circle.remove()
              realLine.remove()
              polyline.draw('done')
              polyline.off()
              canvas.off()
              document.removeEventListener('keydown', this)
            }
          })
        })

        polyline.on('drawpoint', function (event) {
          // console.log('drawpoint')
          printXY(event.detail.event)
          startPoint = event.detail.p.clone()
          circle.remove()
          circle = createCircle(canvas, startPoint)
        })

        polyline.on('drawupdate', function (event) {
          // console.log('drawupdate')

          if (update) {
            var p = event.detail.p
            realLine.plot(startPoint.x, startPoint.y, p.x, p.y)

            var d = distance(startPoint, p)
            circle.radius(d)

            // debugger
            var snappedPoint = snapTo45(startPoint, p)
              .transform(matrix.inverse())

            var emulatedMouseEvent = {
              clientX: snappedPoint.x,
              clientY: snappedPoint.y
            }

            printXY(emulatedMouseEvent)
            currentPoint = emulatedMouseEvent

            update = false
            polyline.draw('update', emulatedMouseEvent)
          }
        })

        function printXY (obj) {
          // console.log(obj.clientX, obj.clientY)
        }

        function createCircle (canvas, point) {
          var r = 20
          var circle = canvas
            .circle(r)
            .stroke({ width:1, dasharray: '4 10' })
            .fill("none")
            .move(point.x - r/2, point.y - r/2)

          return circle
        }

        // function getR (circle) {
        //   return circle.node.r.baseVal.value
        // }

        function distance (v1, v2) {
          if (typeof v1 === "number") return distanceOfNumbers(v1, v2)
          return distanceOfVectors(v1, v2)
        }

        function distanceOfVectors (vector1, vector2) {
          return distanceOfNumbers(subX(vector1, vector2), subY(vector1, vector2))
        }

        function distanceOfNumbers (n1, n2) {
          return Math.sqrt(Math.pow(n1, 2) + Math.pow(n2, 2))
        }

        function subX (v1, v2) {
          return v1.x - v2.x
        }

        function subY(v1, v2) {
          return v1.y - v2.y
        }

        function snapTo45 (startPoint, currentPoint) {
          // solution from https://stackoverflow.com/a/42510911/205696
          var deltaX = subX(currentPoint, startPoint),
              deltaY = subY(currentPoint, startPoint),
              dist = distance(deltaX, deltaY)

          var angle = Math.atan2(deltaY, deltaX)
          // var snappedAngle = (angle / Math.PI * 4) / 4 * Math.PI
          var snappedAngle = Math.round(angle / Math.PI * 4) / 4 * Math.PI
          // console.log(snappedAngle)

          // console.log(deltaX, deltaY, dist, angle, snappedAngle)
          // console.log(startPoint, currentPoint)
          // console.log(dist)

          // return {
          //   clientX: startPoint.x + dist * Math.cos(snappedAngle),
          //   clientY: startPoint.y + dist * Math.sin(snappedAngle)
          // }
          return new SVG.Point(
            startPoint.x + dist * Math.cos(snappedAngle),
            startPoint.y + dist * Math.sin(snappedAngle)
          )
        }

        // function transformPoint (point, matrix) {
        //   this.p.x = x - (this.offset.x - window.pageXOffset)
        //   this.p.y = y - (this.offset.y - window.pageYOffset)

        //   return this.p.transform(this.m)
        // }
      }
    </script>
    <script src="//localhost:35729/livereload.js"></script>
  </body>
</html>
